@page "/C4Editor"
@using LocalEdit.C4Types
@using Blazorise
<h1>C4 Editor</h1> 
<hr/>

<Button Size="Size.Small" Color="Color.Primary" Clicked="@NewC4Document">
    <Icon Name="IconName.Star" />
    New C4 Model
</Button>

<Button Size="Size.Small" Color="Color.Primary" Clicked="@LoadFile">
    <Icon Name="IconName.FileUpload" />
    Load
</Button>

<Button Size="Size.Small" Color="Color.Primary" Clicked="@SaveFile">
    <Icon Name="IconName.FileDownload" />
    Save
</Button>

    <Button Size="Size.Small" Color="Color.Primary" Clicked="@ExportFile">
        <Icon Name="IconName.ArrowRight" />
        Export Markdown Snippet
    </Button>
    <Button Size="Size.Small" Color="Color.Primary" Clicked="@ExportHtml">
        <Icon Name="IconName.ArrowRight" />
        Export HTML
    </Button>

<Tabs SelectedTab="@selectedTab" SelectedTabChanged="@OnSelectedTabChanged">
    <Items>
        <Tab Name="general">General</Tab>
        <Tab Name="model">Model</Tab>
        <Tab Name="relations">Relations</Tab>
        <Tab Name="preview">Preview</Tab>
    </Items>
    <Content>
        <TabPanel Name="general"  Border="Border.Primary">
</TabPanel>
        <TabPanel Name="model"  Border="Border.Primary">
<Button Size="Size.Small" Color="Color.Primary" Clicked="@AddNewItem">
    <Icon Name="IconName.Add" />
    New
</Button>

<Button Size="Size.Small" Color="Color.Primary" Clicked="@AddNewChildItem">
    <Icon Name="IconName.Add" />
    New Child
</Button>

@if (SelectedNode == null)
{
    <Button Size="Size.Small" Color="Color.Primary" Disabled>
        <Icon Name="IconName.Edit" />
        Edit
    </Button>
}
@if (SelectedNode != null)
{
    <Button Size="Size.Small" Color="Color.Primary" Clicked="@ShowItemModal">
        <Icon Name="IconName.Edit" />
        Edit
    </Button>
}

@if (SelectedNode == null)
{
    <Button Size="Size.Small" Color="Color.Primary" Disabled>
    <Icon Name="IconName.Delete" />
    Delete
</Button>
}
@if (SelectedNode != null)
{
    <Button Size="Size.Small" Color="Color.Primary" Clicked="@DeleteItem">
    <Icon Name="IconName.Delete" />
    Delete
</Button>
}
    <Button Size="Size.Small" Color="Color.Secondary" Clicked="() => ShowNewItemModal(parentNode)">Add</Button>
    <Button Size="Size.Small" Color="Color.Secondary" Clicked="() => ShowNewItemModal(SelectedNode)">Add Child</Button>

    <TreeView Nodes="Document.Model"
          GetChildNodes="@(item => item.Children)"
          HasChildNodes="@(item => item.Children?.Any() == true)"
          @bind-SelectedNode="SelectedNode"
        >
        <NodeContent>@context.Text</NodeContent>
   </TreeView>

@*          SelectedNodeChanged="@((C4Item item) => SelChanged(item))" *@

</TabPanel>
        <TabPanel Name="relations"  Border="Border.Primary">
@*<Button Size="Size.Small" Color="Color.Primary" Clicked="@AddNewRelationship">
    <Icon Name="IconName.Add" />
    New
</Button>
@if (selectedRelationshipRow == null)
{
    <Button Size="Size.Small" Color="Color.Primary" Disabled>
        <Icon Name="IconName.Edit" />
        Edit
    </Button>
}
@if (selectedRelationshipRow != null)
{
    <Button Size="Size.Small" Color="Color.Primary" Clicked="@ShowRelationshipModal">
        <Icon Name="IconName.Edit" />
        Edit
    </Button>
}

@if (selectedRelationshipRow == null)
{
    <Button Size="Size.Small" Color="Color.Primary" Disabled>
    <Icon Name="IconName.Delete" />
    Delete
</Button>
}
@if (selectedRelationshipRow != null)
{
    <Button Size="Size.Small" Color="Color.Primary" Clicked="@DeleteRelationship">
    <Icon Name="IconName.Delete" />
    Delete
</Button>
}




            <DataGrid TItem="FlowRelationship"
          Data="@Document.Relationships"
          @bind-SelectedRow="@selectedRelationshipRow"
          Responsive>
          <DataGridColumns>
    <DataGridColumn Field="@nameof( FlowRelationship.From )" Editable="false">
        <DisplayTemplate>
            @{
                string fromCode = ( context as FlowRelationship )?.From;
                string toCode = ( context as FlowRelationship )?.To;

                    if (fromCode != null)
                    {
                        @($"{DecodeFlowId(fromCode)}") <NBSP/> <Icon Name="IconName.ArrowRight"/> <NBSP/> @($"{DecodeFlowId(toCode)}")
                        <br />
                        <span style="padding-left:2em">@($"{context.Label}")</span>
                    }
                //if ( date != null )
                //{
                //    @($"{date.Value.ToShortDateString()} | Age: {( DateTime.Now.Year - date.Value.Year )}")
                //}
            }
        </DisplayTemplate>
    </DataGridColumn>
    </DataGridColumns>
    <EmptyTemplate>
        <div class="box">
            No relations were found!
        </div>
    </EmptyTemplate>
</DataGrid>*@

</TabPanel>
        <TabPanel Name="preview"  Border="Border.Primary">

<StardustDL.RazorComponents.Markdown.MarkdownRenderer
    @ref="markdownRef"
    Value="@MarkdownText"
    Class="your class"
    Style="your styles"
    />
</TabPanel>
    </Content>
</Tabs>






<Button Color="Color.Primary" Clicked="@ShowTestModal">Test Modal</Button>

<Button Color="Color.Primary" Clicked="@ShowModal">Show Modal</Button>

<Span Margin="Margin.Is3.FromStart">Modal is visible: @modalVisible</Span>

<Modal @ref="NewItemModalRef" @bind-Visible="@newItemModalVisible" Closing="@OnNewItemModalClosing" Opened="@OnNewItemModalOpened" Closed ="OnNewItemModalClosed" Size="ModalSize.Small">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Add Item</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @if (ShouldShow(C4TypeEnum.Person, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.Person)">Person</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.System, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.System)">System</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.EnterpriseBoundary, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.EnterpriseBoundary)">Enterprise</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.Container, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.Container)">Container</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.Component, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.Component)">Component</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.Database, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.Database)">Database</Button><p/>
            }
            @if (ShouldShow(C4TypeEnum.Node, potentialParentNode))
            {
                <Button Color="Color.Dark" Block Outline @onclick="() => CreateItem(C4TypeEnum.Node)">Node</Button>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Danger" Clicked="@CloseNewItemModal">Cancel</Button>
        </ModalFooter>
    </ModalContent>
</Modal>


@*<Modal @ref="modalRef" @bind-Visible="@modalVisible" Closing="@OnModalClosing" Opened="@OnModelOpened">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Employee edit</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <PropertyEditor @ref="propEditor" Item=@selectedNode></PropertyEditor>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@CloseModal">Close</Button>
            <Button Color="Color.Primary" Clicked="@TryCloseModal">Save Changes</Button>
        </ModalFooter>
    </ModalContent>
</Modal>
*@

<LocalEdit.Modals.TestModal @ref="testModalRef" Closed="@OnTestModalClosed"></LocalEdit.Modals.TestModal>

<LocalEdit.Modals.C4ItemEditModal @ref="c4ItemModalRef" Closed="@OnC4ItemModalClosed"></LocalEdit.Modals.C4ItemEditModal>

<LocalEdit.Modals.FileManagementModal  @ref="fileManagementModalRef" Closed="@OnFileManagementModalClosed"></LocalEdit.Modals.FileManagementModal>
